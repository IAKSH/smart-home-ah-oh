import { router } from '@kit.ArkUI';
import { DeviceAttribItem } from '../models/Device';
import testNapi from "libentry.so"
import { hilog } from '@kit.PerformanceAnalysisKit';
import { Device } from "../models/Device"

interface RouterParams {
  device: Device;
}

type DeviceAttrib = DeviceAttribItem[];

//
// å­—æ®µé…ç½®æ¥å£
//
interface FieldConfig {
  name: string;
  unit: string;
}

@Entry
@Component
struct DeviceDetail {
  // é€šè¿‡ @State å£°æ˜è®¾å¤‡æ•°æ®ï¼Œé»˜è®¤ä½¿ç”¨ç©ºè®¾å¤‡å¯¹è±¡åˆå§‹åŒ–
  @State device: Device = new Device();

  // å­—æ®µé…ç½®æ˜ å°„ï¼ŒåŒåˆ—è¡¨é¡µé¢ä¿æŒä¸€è‡´
  private fieldConfig: Map<string, FieldConfig> = new Map([
    ['temperature', { name: 'æ¸©åº¦', unit: 'â„ƒ' } as FieldConfig],
    ['humidity', { name: 'æ¹¿åº¦', unit: '%' }],
    ['power', { name: 'åŠŸç‡', unit: 'W' }],
    ['voltage', { name: 'ç”µå‹', unit: 'V' }],
    ['co2', { name: 'äºŒæ°§åŒ–ç¢³', unit: 'ppm' }],
    ['alert', { name: 'è­¦æŠ¥', unit: '' }]
  ]);

  updateRemoteDevice(key: string, newValue: string | number | boolean): void {
    hilog.info(0, 'DEBUG', 'update attrib %{public}s to %{public}s', key, newValue);
    class Data {
      value: string = ''
    }
    let data: Data = { value: newValue.toString() };
    testNapi.publish(`/device/${this.device.id}/attrib/${key}`, JSON.stringify(data));
  }

  // æ ¹æ®ç›®æ ‡ç±»å‹å°†è¾“å…¥å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹åº”ç±»å‹å€¼
  private convertValue(value: string, targetType: string): string | number | boolean {
    if (targetType === 'number') {
      const num = Number(value);
      return isNaN(num) ? 0 : num;
    } else if (targetType === 'boolean') {
      return value.toLowerCase() === 'true';
    }
    return value;
  }

  // æ–°å¢ï¼šæäº¤ä¿å­˜ä¿®æ”¹æ—¶è°ƒç”¨ï¼Œå°†æ‰€æœ‰å¯å†™å­—æ®µçš„ä¿®æ”¹ç»Ÿä¸€å‘é€åç«¯
  private submitChanges(): void {
    for (let item of this.device.attrib) {
      if (item.w) {
        this.updateRemoteDevice(item.key, item.value);
      }
    }
  }

  // ç”¨äºæ ¹æ®å±æ€§æ˜¯å¦å¯å†™æ¥ç”Ÿæˆç›¸åº”çš„è¾“å…¥æˆ–åªè¯»å±•ç¤ºç»„ä»¶
  @Builder
  InputComponent(item: DeviceAttribItem) {
    if (item.w) {
      TextInput({ text: item.value.toString() })
        .fontSize(16)
        .layoutWeight(2)
        .onChange((value: string) => {
          // ä»…æ›´æ–°æœ¬åœ°å±æ€§å€¼ï¼Œä¸ç«‹å³å‘é€è¯·æ±‚
          const newVal = this.convertValue(value, typeof item.value);
          item.value = newVal;
        });
    } else {
      Text(item.value.toString() + (this.fieldConfig.get(item.key)?.unit ?? ''))
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(2)
        .textAlign(TextAlign.End);
    }
  }

  // å±æ€§é¡¹æ„å»ºå™¨ï¼šå±•ç¤ºå±æ€§åç§°å’Œå¯¹åº”çš„å€¼ï¼ˆä»¥åŠå¯èƒ½çš„è¾“å…¥æ¡†ï¼‰
  @Builder
  AttribItem(item: DeviceAttribItem, displayName: string) {
    Column() {
      Row() {
        // å·¦ä¾§åç§°éƒ¨åˆ†ï¼Œå›ºå®šå ä½
        Text(displayName)
          .fontSize(16)
          .fontColor('#666')
          .layoutWeight(1)
          .textAlign(TextAlign.Start);
        // å³ä¾§è¾“å…¥/åªè¯»ç»„ä»¶ç›´æ¥è°ƒç”¨ InputComponent
        this.InputComponent(item);
      }
      .padding(4)
      .backgroundColor('#F0F0F0')
      .borderRadius(4);
      Row() {
        // åˆ†å‰²çº¿
      }
      .width("100%")
      .height(1)
      .backgroundColor("#ddd")
      .margin({ top: 4 });
    }
    .margin({ bottom: 4 });
  }

  // ç”¨äºæ ¹æ® key è·å–æ˜¾ç¤ºåç§°çš„æ–¹æ³•ï¼ˆé¿å…ç›´æ¥åœ¨UIä¸­ä½¿ç”¨å±€éƒ¨å˜é‡ï¼‰
  private getDisplayName(key: string): string {
    const config = this.fieldConfig.get(key);
    return config ? config.name : key;
  }

  build() {
    Column() {
      // æ»šåŠ¨è¯¦æƒ…åŒºåŸŸï¼šåŒ…å«æ ‡é¢˜ã€å›¾ç‰‡ã€åŸºæœ¬ä¿¡æ¯å’Œå±æ€§æ•°æ®
      Scroll() {
        Column() {
          // æ ‡é¢˜åŒºåŸŸåŠè®¾å¤‡å›¾ç‰‡
          Column() {
            Text("è®¾å¤‡è¯¦æƒ…")
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .textAlign(TextAlign.Center)
              .width("100%")
              .margin({ bottom: 12 });
            Image(this.device.icon)
              .width("100%")
              .height(200);
          }
          .padding({ left: 16, right: 16, top: 20, bottom: 12 })
          .backgroundColor('#FFF')
          .shadow({ radius: 4, color: '#1A000000', offsetX: 1, offsetY: 1 })
          .width("100%");

          // è®¾å¤‡åŸºæœ¬ä¿¡æ¯ï¼šåç§°å’ŒçŠ¶æ€
          Row() {
            Text("åç§°ï¼š").fontSize(14);
            Text(this.device.name).fontSize(14);
          }
          .margin({ top: 12, bottom: 8 })
          .width("100%");
          Row() {
            Text("çŠ¶æ€ï¼š").fontSize(14);
            Text(this.device.status)
              .fontSize(14)
              .fontColor(this.device.status === 'åœ¨çº¿' ? '#07C160' : '#999');
          }
          .margin({ bottom: 16 })
          .width("100%");

          // éå†æ˜¾ç¤ºæ‰€æœ‰å±æ€§æ•°æ®
          ForEach(this.device.attrib, (item: DeviceAttribItem) => {
            this.AttribItem(item, this.getDisplayName(item.key));
          });
        }
        .padding({ left: 16, right: 16, top: 16, bottom: 120 })
        .backgroundColor('#FFF')
        .width("100%");
      }
      .layoutWeight(1)
      .width("100%")
      .backgroundColor('#F5F5F5');

      // å›ºå®šåœ¨é¡µé¢åº•éƒ¨çš„æ“ä½œæŒ‰é’®åŒºåŸŸï¼ˆä¸éšæ»šåŠ¨å†…å®¹ç§»åŠ¨ï¼‰
      Row() {
        Button("ğŸ’¾ ä¿å­˜ä¿®æ”¹")
          .onClick(() => {
            // ç‚¹å‡»æŒ‰é’®åç»Ÿä¸€æäº¤ä¿®æ”¹
            this.submitChanges();
          })
          .layoutWeight(1)
          .backgroundColor("transparent")
          .fontColor("#007AFF")
          .borderWidth(0);
        Button("ğŸ—‘ åˆ é™¤è®¾å¤‡")
          .onClick(() => {
            //console.log("åˆ é™¤è®¾å¤‡");
          })
          .layoutWeight(1)
          .backgroundColor("transparent")
          .fontColor("#FF3B30")
          .borderWidth(0)
          .margin({ left: 8 });
      }
      .height(60)
      .backgroundColor("#FFF")
      .width("100%");
    }
    .width("100%")
    .height("100%")
    .onAppear(() => {
      // åœ¨é¡µé¢å‡ºç°æ—¶ï¼Œé€šè¿‡è·¯ç”±å‚æ•°æ›´æ–°è®¾å¤‡ä¿¡æ¯
      const params = router.getParams() as RouterParams;
      this.device = params.device;
    });
  }
}
