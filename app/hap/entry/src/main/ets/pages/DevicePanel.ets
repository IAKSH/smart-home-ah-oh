import { router } from '@kit.ArkUI';
import { Device, DeviceAttrib, DeviceAttribItem } from '../models/Device';
import testNapi from "libentry.so"
import { hilog } from '@kit.PerformanceAnalysisKit';
import { activeServer } from '../data/ServerStore';

//
// å®šä¹‰å­—æ®µé…ç½®æ¥å£
//
interface FieldConfig {
  name: string;
  unit: string;
}

// å®šä¹‰ JSON æ•°æ®å¯¹åº”çš„æ¥å£
interface MetaAttrib {
  desc: string;
  rw: string;
  topic: string;
  type: string;
}

interface MetaData {
  attrib: MetaAttrib[];
  attrib_schema: string;
  desc: string;
  heartbeat_interval: number;
  type: string[];
}

interface DeviceMetaResponse {
  device_id: string;
  meta: MetaData;
}

interface FetchDevicesResponse {
  devices: DeviceMetaResponse[];
}

@Entry
@Component
export default struct DevicePanel {
  // è®¾å¤‡åˆ—è¡¨æ•°æ®ï¼Œä¸»é¡µé¢å¯é€šè¿‡è°ƒç”¨å‰å¯¹è¯¥å±æ€§èµ‹å€¼æ¥ä¼ å…¥æ•°æ®
  @State devices: Device[] = [];
  // æ¬¢è¿åŒºåŸŸä¸­ä½¿ç”¨çš„ç”¨æˆ·åï¼Œé»˜è®¤å€¼å¯è¦†ç›–
  @State username: string = "OHOS_User";

  // å­—æ®µé…ç½®æ˜ å°„ï¼Œä¸è¯¦æƒ…é¡µä¿æŒä¸€è‡´
  private fieldConfig: Map<string, FieldConfig> = new Map([
    ['temperature', { name: 'æ¸©åº¦', unit: 'â„ƒ' } as FieldConfig],
    ['humidity', { name: 'æ¹¿åº¦', unit: '%' }],
    ['power', { name: 'åŠŸç‡', unit: 'W' }],
    ['voltage', { name: 'ç”µå‹', unit: 'V' }],
    ['co2', { name: 'äºŒæ°§åŒ–ç¢³', unit: 'ppm' }],
    ['alert', { name: 'è­¦æŠ¥', unit: '' }]
  ]);

  timerId: number | undefined;

  async fetchDevices(): Promise<void> {
    try {
      // è·å–æ¥å£è¿”å›çš„ HTTP å“åº”å­—ç¬¦ä¸²
      const response: string = await testNapi.fetchDevices();

      // å®šä½ JSON éƒ¨åˆ†ï¼Œå¹¶æˆªå–å‡º JSON å­—ç¬¦ä¸²
      const jsonStart: number = response.indexOf('{');
      if (jsonStart === -1) {
        throw new Error("æœªæ‰¾åˆ° JSON æ•°æ®");
      }
      const jsonStr: string = response.substring(jsonStart).trim();

      // è§£æ JSON æ•°æ®ï¼Œå‡è®¾è¿”å›æ•°æ®ç±»å‹ä¸º FetchDevicesResponse
      const responseData: FetchDevicesResponse = JSON.parse(jsonStr) as FetchDevicesResponse;

      // æ„é€ ä»æœåŠ¡å™¨è¿”å›çš„æ–°è®¾å¤‡æ•°ç»„
      const devicesNew: Device[] = [];
      const deviceList: DeviceMetaResponse[] = responseData.devices;
      for (let i = 0; i < deviceList.length; i++) {
        const devItem: DeviceMetaResponse = deviceList[i];
        // å‡è®¾è®¾å¤‡ ID ç±»å‹ç»Ÿä¸€ä¸ºå­—ç¬¦ä¸²ï¼ˆæ³¨æ„ï¼šå¦‚æœ Device.id ä¸º numberï¼Œå¯è½¬æ¢ï¼šNumber(devItem.device_id)ï¼‰
        const devId: string = devItem.device_id;
        const devMeta: MetaData = devItem.meta;

        // æ„é€ æ–°è®¾å¤‡å¯¹è±¡
        const newDevice: Device = new Device();
        newDevice.id = devId;  // å»ºè®®ä¿è¯ç±»å‹ä¸€è‡´
        newDevice.name = devMeta.desc || ("Device " + (i + 1));
        newDevice.status = "åœ¨çº¿"; // é»˜è®¤çŠ¶æ€
        newDevice.icon = "resources/base/media/startIcon.png";
        newDevice.attrib = [];

        // æ ¹æ®å…ƒæ•°æ®ä¸­çš„ attrib æ„é€ è®¾å¤‡å±æ€§æ•°ç»„: { key, value }
        if (devMeta.attrib && Array.isArray(devMeta.attrib)) {
          for (const attr of devMeta.attrib) {
            let key: string;
            // å»æ‰ topic å‰é¢çš„æ–œæ 
            if (attr.topic && attr.topic.startsWith("/")) {
              key = attr.topic.substring(1);
            } else {
              key = attr.topic || "unknown";
            }
            let defaultValue: number | boolean | string;
            if (attr.type === "float" || attr.type === "int") {
              defaultValue = 0;
            } else if (attr.type === "bool") {
              defaultValue = false;
            } else {
              defaultValue = "";
            }
            // æ³¨æ„ï¼šè¿™é‡Œé‡‡ç”¨å¯¹è±¡å½¢å¼ï¼Œç¡®ä¿åˆå¹¶æ—¶å¯ä»¥ç›´æ¥è®¿é—® key å’Œ value
            newDevice.attrib.push({ key: key, value: defaultValue, r: attr.rw[0] === 'r', w: attr.rw[0] === 'w' || attr.rw[1] === 'w' });
          }
        }
        devicesNew.push(newDevice);
      }

      // åˆå¹¶æ•°æ®ï¼šå¯¹æ¯”ä»æœåŠ¡å™¨æ–°æ„é€ çš„æ•°æ®ï¼ˆdevicesNewï¼‰ä¸å½“å‰ this.devicesï¼Œ
      // ä¿ç•™å·²æ›´æ–°ï¼ˆéé»˜è®¤ï¼‰çš„ attrib å€¼ï¼Œå…¶ä»–æƒ…å†µé‡‡ç”¨æœåŠ¡å™¨æ•°æ®
      const mergedDevices: Device[] = devicesNew.map(newDev => {
        // åœ¨æ—§æ•°æ®ä¸­æŸ¥æ‰¾åŒä¸€ä¸ªè®¾å¤‡ï¼ˆæ ¹æ®IDåŒ¹é…ï¼‰
        const oldDev: Device | undefined = this.devices.find(d => d.id === newDev.id);
        if (oldDev) {
          // éå†æ–°è®¾å¤‡çš„ attrib æ•°ç»„ï¼ŒæŒ‰ key è¿›è¡ŒåŒ¹é…åˆå¹¶
          newDev.attrib = newDev.attrib.map(newAttr => {
            const oldAttr = oldDev.attrib.find(attr => attr.key === newAttr.key);
            if (oldAttr !== undefined) {
              // å¦‚æœå±æ€§å€¼è¢«æ›´æ–°ï¼ˆå³æ—§å€¼ä¸å†æ˜¯é»˜è®¤å€¼ï¼‰ï¼Œåˆ™ä¿ç•™æ—§å€¼
              if (typeof newAttr.value === "number") {
                if (oldAttr.value !== 0) {
                  return { key: newAttr.key, value: oldAttr.value, r: newAttr.r, w: newAttr.w };
                }
              } else if (typeof newAttr.value === "boolean") {
                if (oldAttr.value !== false) {
                  return { key: newAttr.key, value: oldAttr.value, r: newAttr.r, w: newAttr.w };
                }
              } else if (typeof newAttr.value === "string") {
                if (oldAttr.value !== "") {
                  return { key: newAttr.key, value: oldAttr.value, r: newAttr.r, w: newAttr.w };
                }
              }
            }
            // æ— æ›´æ–°åˆ™ç›´æ¥ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„å±æ€§é¡¹
            return newAttr;
          });
          // å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥ä¿ç•™æ—§è®¾å¤‡çš„å…¶å®ƒå­—æ®µï¼ˆä¾‹å¦‚åç§°ã€çŠ¶æ€ã€å›¾æ ‡ç­‰ï¼‰
          newDev.name = oldDev.name;
          newDev.status = oldDev.status;
          newDev.icon = oldDev.icon;
        }
        return newDev;
      });

      // æ›´æ–° @State devices å˜é‡ï¼Œè§¦å‘ç•Œé¢é‡æ¸²æŸ“
      hilog.info(0, 'TestPage', 'Merged devices = %{public}s', JSON.stringify(mergedDevices));
      this.devices = mergedDevices;
    } catch (error) {
      hilog.error(0, 'TestPage', 'fetchDevices error: %{public}s', error.message);
    }
  }

  aboutToAppear() {
    testNapi.connectServer(activeServer.ip, "80");
    testNapi.connectBroker("tcp://192.168.31.110:1883", "ArkUI_MQTT_Client");

    testNapi.registerMQTTCallback((topic: string, payload: string) => {
      hilog.info(0, 'TestPage', 'received topic: %{public}s, payload: %{public}s', topic, payload);

      // å‡è®¾å®é™… topic æ ¼å¼ï¼Œä¾‹å¦‚ï¼š/device/12345/attrib/temperature
      let regex = /\/device\/([^\/]+)\/attrib\/([^\/]+)/;
      let match = topic.match(regex);
      if (match) {
        let deviceId = match[1];
        let attribId = match[2];
        hilog.info(0, 'TestPage', `device_id: ${deviceId}`);
        hilog.info(0, 'TestPage', `attrib_id: ${attribId}`);

        let matchedDevice: Device | undefined = this.devices.find((device: Device) => device.id === deviceId);
        if (matchedDevice) {
          let updated = false;
          let newAttrib: DeviceAttrib = []; // ç”¨äºæ„é€ æ–°çš„ attrib æ•°ç»„

          for (let j = 0; j < matchedDevice.attrib.length; j++) {
            // ç›´æ¥è®¿é—®å¯¹è±¡å±æ€§ï¼Œä¸ä½¿ç”¨æ•°ç»„ç´¢å¼•æ–¹å¼è·å–å­—æ®µ
            let item: DeviceAttribItem = matchedDevice.attrib[j];
            if (item.key === attribId) {
              try {
                // è§£æ JSON å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š'{"value": "true"}' æˆ– '{"value": "3.14"}'
                class Payload {
                  value: string = '';
                }
                let parsedPayload: Payload= JSON.parse(payload);
                let rawValue = parsedPayload.value;
                let convertedValue: string | number | boolean;
                if (typeof rawValue === "string") {
                  if (rawValue.toLowerCase() === "true") {
                    convertedValue = true;
                  } else if (rawValue.toLowerCase() === "false") {
                    convertedValue = false;
                  } else if (!isNaN(Number(rawValue))) {
                    convertedValue = Number(rawValue);
                  } else {
                    convertedValue = rawValue;
                  }
                } else {
                  convertedValue = rawValue;
                }
                // ä½¿ç”¨æ–°çš„å€¼æ„é€ æ–°çš„å±æ€§é¡¹
                newAttrib.push({ key: item.key, value: convertedValue, r: item.r, w: item.w });
              } catch (error) {
                hilog.info(0, 'TestPage', "JSONè§£æé”™è¯¯: %{public}s", String(error));
                // å‡ºç°è§£æé”™è¯¯æ—¶ï¼Œä¹Ÿå°†åŸå§‹é¡¹å¤åˆ¶è¿›å»ï¼Œä¿è¯æ•°ç»„é•¿åº¦ä¸å˜
                newAttrib.push({ key: item.key, value: item.value, r: item.r, w: item.w });
              }
              updated = true;
            } else {
              // æœªåŒ¹é…æ—¶ï¼Œç›´æ¥å¤åˆ¶ä¸€ä»½æ–°çš„å¯¹è±¡ï¼Œç¡®ä¿ä¸å¯å˜æ›´æ–°
              newAttrib.push({ key: item.key, value: item.value, r: item.r, w: item.w });
            }
          }

          if (!updated) {
            hilog.info(0, 'TestPage', 'unable to find attrib %{public}s in device %{public}s, ignored', attribId, deviceId);
          } else {
            // åˆ›å»ºæ–°çš„ Device å®ä¾‹ï¼Œå¹¶æ‰‹åŠ¨å¤åˆ¶å±æ€§
            let newDevice: Device = new Device();
            newDevice.id = matchedDevice.id;
            newDevice.name = matchedDevice.name;
            newDevice.status = matchedDevice.status;
            newDevice.icon = matchedDevice.icon;
            newDevice.attrib = newAttrib;

            // æ›´æ–° devices æ•°ç»„ï¼ˆé‡‡ç”¨ä¸å¯å˜æ›´æ–°ç­–ç•¥ï¼‰
            this.devices = this.devices.map((device: Device) => {
              if (device.id === newDevice.id) {
                return newDevice;
              } else {
                return device;
              }
            });

            hilog.info(0, 'TestPage', "[DEBUG] æ›´æ–° attrib æˆåŠŸ");
          }
        } else {
          hilog.info(0, 'TestPage', 'unable to find device with id: %{public}s', deviceId);
        }
      } else {
        hilog.info(0, 'TestPage', "æœªæ‰¾åˆ°åŒ¹é…é¡¹");
      }
    });

    testNapi.subscribe("/device/#");
    this.timerId = setInterval(() => {
      this.fetchDevices();
      //testNapi.napiCallbackTest((str: string) => {
      // hilog.info(0, 'TestPage', 'called callback, str = %{public}s',str);
      // testNapi.publish("/hello","123456");
      //});
    },1000);
  }

  aboutToDisappear() {
    if(this.timerId !== undefined) {
      clearInterval(this.timerId);
    }
  }

  // å±æ€§é¡¹æ„å»ºå™¨ï¼šæ¯é¡¹æ•°æ®ä»¥åç§°å·¦å¯¹é½ã€æ•°å€¼å³å¯¹é½ï¼Œå¹¶åœ¨ä¸‹æ–¹æ·»åŠ åˆ†å‰²çº¿
  @Builder
  AttribItem(displayName: string, valueWithUnit: string) {
    Column() {
      Row() {
        Text(displayName)
          .fontSize(16)
          .fontColor('#666')
          .layoutWeight(1)
          .textAlign(TextAlign.Start);
        Text(valueWithUnit)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.End);
      }
      .padding(4)
      .backgroundColor('#F0F0F0')
      .borderRadius(4);
      // åˆ†å‰²çº¿
      Row() {}
      .width("100%")
      .height(1)
      .backgroundColor("#ddd")
      .margin({ top: 4 });
    }
    .margin({ bottom: 4 });
  }

  // è®¾å¤‡å¡ç‰‡æ„å»ºå™¨ï¼šç‚¹å‡»å¡ç‰‡åå¯¼èˆªåˆ°è®¾å¤‡è¯¦æƒ…é¡µ
  @Builder
  DeviceCard(device: Device) {
    Column() {
      // å¡ç‰‡å¤´éƒ¨ï¼šå›¾æ ‡ã€åç§°ã€çŠ¶æ€
      Row() {
        Image(device.icon)
          .width(20)
          .height(20)
          .margin({ right: 6 });
        Text(device.name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1);
        Text(device.status)
          .fontSize(12)
          .fontColor(device.status === 'åœ¨çº¿' ? '#07C160' : '#999');
      }
      .width('100%')
      .padding({ bottom: 8 });
      // è®¾å¤‡å±æ€§æ•°æ®åŒºåŸŸï¼šåªæ˜¾ç¤ºå‰ä¸‰é¡¹ï¼Œå¤šä½™çš„æ˜¾ç¤ºâ€œ[æ›´å¤š]â€
      Column() {
        ForEach(
          device.attrib.slice(0, device.attrib.length > 2 ? 2 : device.attrib.length),
          (item: DeviceAttribItem) => {
            this.AttribItem(
              this.fieldConfig.get(item.key)?.name ?? item.key,
              `${item.value.toString()}${this.fieldConfig.get(item.key)?.unit ?? ''}`
            );
          }
        );
        if (device.attrib.length > 2) {
          Row() {
            Text("[æ›´å¤š]")
              .fontSize(14)
              .fontColor('#999');
          }
        }
      }
    }
    .padding(12)
    .backgroundColor('#FFF')
    .borderRadius(12)
    .shadow({ radius: 6, color: '#1A000000', offsetX: 1, offsetY: 1 })
    .width('46%')
    .aspectRatio(1)
    .margin({ right: 12, bottom: 12 })
    .onClick(() => {
      router.pushUrl({
        url: 'pages/DeviceDetail',
        params: { device: device }
      });
    });
  }

  // å…¥å£ build æ–¹æ³•ï¼šæ„å»ºæ•´ä¸ªè®¾å¤‡åˆ—è¡¨é¡µé¢ï¼ˆåŒ…å«æ¬¢è¿å¡ç‰‡åŠè®¾å¤‡å¡ç‰‡çŸ©é˜µï¼‰
  @Builder
  build() {
    Scroll() {
      Column() {
        // æ¬¢è¿å¡ç‰‡åŒºåŸŸ
        Column() {
          // æ¬¢è¿é—®å€™
          Text("ğŸ˜Š ä½ å¥½ï¼Œ" + this.username + "!")
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor("#333")
            .width("100%")
            .margin({ bottom: 8 });
          // è®¾å¤‡ç»Ÿè®¡ä¿¡æ¯
          Text("å½“å‰è®¾å¤‡æ•°ï¼š" + this.devices.length + "ï¼Œåœ¨çº¿æ•°ï¼š" +
          this.devices.filter((d: Device) => d.status === 'åœ¨çº¿').length)
            .fontSize(16)
            .fontColor("#666")
            .width("100%")
            .margin({ bottom: 8 });
          // æ¬¢è¿è¯´æ˜æ–‡æœ¬
          Text("æ¬¢è¿ä½¿ç”¨æˆ‘ä»¬çš„æ™ºèƒ½å®¶åº­å¹³å°ï¼Œè®©ç”Ÿæ´»æ›´æ™ºèƒ½ï¼")
            .fontSize(14)
            .fontColor("#999")
            .width("100%")
            .margin({ bottom: 12 });
          // æ·»åŠ è®¾å¤‡æŒ‰é’®ï¼Œå³å¯¹é½
          Row() {
            Button() {
              Row() {
                Text("â• æ·»åŠ è®¾å¤‡")
                  .fontSize(16)
                  .fontColor("#007AFF");
              }
            }
            .padding({ top: 12, bottom: 12, left: 16, right: 16 })
            .backgroundColor("transparent")
            .borderWidth(0)
            .onClick(() => {
              console.log("æ·»åŠ è®¾å¤‡");
            });
          }
          .justifyContent(FlexAlign.End);
        }
        .padding({ left: 12, right: 12, top: 40, bottom: 40 })
        .backgroundColor("#FFF")
        .borderRadius(12)
        .shadow({ radius: 6, color: "#1A000000", offsetX: 1, offsetY: 1 })
        .margin({ left: 12, right: 12, bottom: 16 });

        // è®¾å¤‡å¡ç‰‡çŸ©é˜µï¼šä»¥ Flex å¸ƒå±€ä¸¤åˆ—æ˜¾ç¤º
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
          ForEach(this.devices, (device: Device) => {
            this.DeviceCard(device);
          });
        }
        .padding(12);

        // å¢åŠ é¢å¤–çš„åº•éƒ¨ç©ºé—´ï¼Œç¡®ä¿æœ€åä¸€æ’è®¾å¤‡å¡ç‰‡ä¸ä¼šè¢«é®æŒ¡
        Row() {}.height(80);
      }
      .width("100%")
      // ä¸ºä¿è¯é¡¶éƒ¨å†…å®¹å®Œæ•´å±•ç¤ºï¼Œå¢åŠ é¢å¤–çš„ä¸Šä¸‹å†…è¾¹è·
      .padding({ top: 20, bottom: 20 });
    }
    .layoutWeight(1)
      .width("100%");
  }
}
